{% extends "base.html" %}

{% block title %}Consultants{% endblock %}

{% block content %}
<div class="space-y-6">
    <div class="flex justify-between items-center">
        <div>
            <h2 class="text-3xl font-bold text-primary-text-dark">Consultants</h2>
            <p class="mt-2 text-secondary-text-dark">Manage consultant profiles</p>
        </div>
        <div class="flex gap-2">
            <button onclick="window.openUploadModal()" class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-accent-dark hover:bg-accent-dark/80 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-accent-dark">
                <i class="fas fa-upload mr-2"></i>Upload CV
            </button>
            <a href="/consultant/consultants/add" class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500">
                <i class="fas fa-plus mr-2"></i>Add Manually
            </a>
        </div>
    </div>

    <!-- Filters -->
    <div class="bg-primary-dark p-4 rounded-lg shadow-lg">
        <form method="get" action="/consultant/consultants" class="flex flex-wrap items-end gap-4">
            <div>
                <label for="active" class="block text-sm font-medium text-secondary-text-dark">Status</label>
                <select id="active" name="active" class="mt-1 block w-full pl-3 pr-10 py-2 text-base bg-secondary-dark border-gray-600 focus:outline-none focus:ring-accent-dark focus:border-accent-dark sm:text-sm rounded-md text-primary-text-dark">
                    <option value="true" {% if active %}selected{% endif %}>Active</option>
                    <option value="false" {% if not active %}selected{% endif %}>Inactive</option>
                    <option value="">All</option>
                </select>
            </div>
            <div>
                <label for="limit" class="block text-sm font-medium text-secondary-text-dark">Show</label>
                <select id="limit" name="limit" class="mt-1 block w-full pl-3 pr-10 py-2 text-base bg-secondary-dark border-gray-600 focus:outline-none focus:ring-accent-dark focus:border-accent-dark sm:text-sm rounded-md text-primary-text-dark">
                    <option value="20" {% if limit == 20 %}selected{% endif %}>20</option>
                    <option value="50" {% if limit == 50 %}selected{% endif %}>50</option>
                    <option value="100" {% if limit == 100 %}selected{% endif %}>100</option>
                </select>
            </div>
            <button type="submit" class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-accent-dark hover:bg-accent-dark/80 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-accent-dark">
                Apply Filters
            </button>
        </form>
    </div>

    <!-- Consultants List -->
    <div class="bg-primary-dark shadow-lg rounded-lg overflow-hidden">
        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-700">
                <thead class="bg-secondary-dark">
                    <tr>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-secondary-text-dark uppercase tracking-wider">Name</th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-secondary-text-dark uppercase tracking-wider">Role</th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-secondary-text-dark uppercase tracking-wider">Seniority</th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-secondary-text-dark uppercase tracking-wider">Skills</th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-secondary-text-dark uppercase tracking-wider">Location</th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-secondary-text-dark uppercase tracking-wider">Status</th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-secondary-text-dark uppercase tracking-wider">Actions</th>
                    </tr>
                </thead>
                <tbody class="bg-primary-dark divide-y divide-gray-700">
                    {% for consultant in consultants %}
                    <tr>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-primary-text-dark">{{ consultant.name }}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-secondary-text-dark">{{ consultant.role }}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-secondary-text-dark">
                            <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-gray-700 text-gray-300">{{ consultant.seniority }}</span>
                        </td>
                        <td class="px-6 py-4 text-sm text-secondary-text-dark">
                            <div class="flex flex-wrap gap-1">
                                {% for skill in consultant.skills[:3] %}
                                <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-accent-dark/20 text-accent-dark">{{ skill }}</span>
                                {% endfor %}
                                {% if consultant.skills|length > 3 %}
                                <span class="text-xs text-gray-400">+{{ consultant.skills|length - 3 }} more</span>
                                {% endif %}
                            </div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-secondary-text-dark">{{ consultant.location_city }} <span class="text-gray-400">({{ consultant.onsite_mode }})</span></td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-secondary-text-dark">
                            {% if consultant.active %}
                            <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-900/50 text-green-300">Active</span>
                            {% else %}
                            <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-gray-700 text-gray-300">Inactive</span>
                            {% endif %}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                            <a href="/consultant/matches?consultant_id={{ consultant.consultant_id }}" class="text-accent-dark hover:text-accent-dark/80 mr-3">View Matches</a>
                            <button type="button" hx-post="/consultant/matches/generate/consultant/{{ consultant.consultant_id }}" hx-target="#match-result-{{ consultant.consultant_id }}" class="text-green-400 hover:text-green-300">Generate Matches</button>
                        </td>
                    </tr>
                    <tr id="match-result-{{ consultant.consultant_id }}"><td colspan="7"></td></tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- CV Upload Modal -->
<div id="cv-upload-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 hidden">
    <div class="bg-primary-dark rounded-lg shadow-xl p-6 w-full max-w-md m-4">
        <h3 class="text-lg font-bold text-primary-text-dark mb-4">Upload Consultant CV</h3>
        
        <div id="upload-area" class="border-2 border-dashed border-gray-600 rounded-lg p-6 text-center hover:border-accent-dark transition-colors cursor-pointer">
            <i class="fas fa-upload text-4xl text-secondary-text-dark mb-3"></i>
            <p class="text-sm text-secondary-text-dark mb-2">Drop CV file here or click to browse</p>
            <p class="text-xs text-gray-500">Supported formats: PDF, DOCX, TXT</p>
            <input type="file" id="cv-file-input" accept=".pdf,.docx,.doc,.txt" class="hidden">
        </div>
        
        <div id="file-selected" class="hidden mt-4">
            <p class="text-sm text-secondary-text-dark">Selected file: <span id="file-name" class="font-medium text-primary-text-dark"></span></p>
            <div class="mt-2 bg-accent-dark/10 border border-accent-dark/20 rounded p-2">
                <p class="text-xs text-accent-dark">AI will extract consultant information from the CV</p>
            </div>
        </div>
        
        <div id="upload-progress" class="hidden mt-4">
            <div class="w-full bg-secondary-dark rounded-full h-2">
                <div id="progress-bar" class="bg-accent-dark h-2 rounded-full" style="width: 0%"></div>
            </div>
            <p class="text-sm text-secondary-text-dark mt-2">Processing CV with AI...</p>
        </div>
        
        <div id="upload-result" class="hidden mt-4"></div>
        
        <div class="flex justify-end space-x-3 mt-6">
            <button onclick="window.closeUploadModal()" class="px-4 py-2 bg-secondary-dark text-primary-text-dark text-sm rounded-md hover:bg-gray-600">Cancel</button>
            <button id="upload-btn" onclick="window.uploadCV()" disabled class="px-4 py-2 bg-accent-dark text-white text-sm rounded-md hover:bg-accent-dark/80 disabled:bg-gray-600 disabled:cursor-not-allowed">Upload & Process</button>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
let selectedFile = null;

window.openUploadModal = function() {
    document.getElementById('cv-upload-modal').classList.remove('hidden');
    document.getElementById('file-selected').classList.add('hidden');
    document.getElementById('upload-progress').classList.add('hidden');
    document.getElementById('upload-result').classList.add('hidden');
    document.getElementById('upload-btn').disabled = true;
    selectedFile = null;
}

window.closeUploadModal = function() {
    document.getElementById('cv-upload-modal').classList.add('hidden');
}

const uploadArea = document.getElementById('upload-area');
const fileInput = document.getElementById('cv-file-input');

uploadArea.addEventListener('click', () => fileInput.click());

uploadArea.addEventListener('dragover', (e) => {
    e.preventDefault();
    uploadArea.classList.add('border-accent-dark');
});

uploadArea.addEventListener('dragleave', () => {
    uploadArea.classList.remove('border-accent-dark');
});

uploadArea.addEventListener('drop', (e) => {
    e.preventDefault();
    uploadArea.classList.remove('border-accent-dark');
    if (e.dataTransfer.files.length > 0) {
        handleFileSelection(e.dataTransfer.files[0]);
    }
});

fileInput.addEventListener('change', (e) => {
    if (e.target.files.length > 0) {
        handleFileSelection(e.target.files[0]);
    }
});

function handleFileSelection(file) {
    const allowedTypes = ['application/pdf', 'application/vnd.openxmlformats-officedocument.wordprocessingml.document', 'application/msword', 'text/plain'];
    if (!allowedTypes.includes(file.type) && !file.name.endsWith('.txt')) {
        alert('Please select a PDF, DOCX, or TXT file');
        return;
    }
    selectedFile = file;
    document.getElementById('file-name').textContent = file.name;
    document.getElementById('file-selected').classList.remove('hidden');
    document.getElementById('upload-btn').disabled = false;
}

window.uploadCV = async function() {
    if (!selectedFile) return;

    const formData = new FormData();
    formData.append('file', selectedFile);

    document.getElementById('upload-progress').classList.remove('hidden');
    document.getElementById('upload-btn').disabled = true;

    let progress = 0;
    const progressInterval = setInterval(() => {
        progress += 10;
        if (progress <= 90) {
            document.getElementById('progress-bar').style.width = progress + '%';
        }
    }, 200);

    try {
        const response = await fetch('/api/consultants/upload-cv', {
            method: 'POST',
            body: formData
        });

        clearInterval(progressInterval);
        document.getElementById('progress-bar').style.width = '100%';

        const result = await response.json();

        if (response.ok) {
            document.getElementById('upload-result').innerHTML = `
                <div class="bg-green-900/50 border border-green-700 rounded p-3">
                    <p class="text-sm font-medium text-green-300">${result.message}</p>
                    ${result.consultant ? `
                        <div class="mt-2 text-xs text-green-400">
                            <p>Name: ${result.consultant.name}</p>
                            <p>Role: ${result.consultant.role}</p>
                            <p>Skills: ${result.consultant.skills?.join(', ')}</p>
                        </div>
                    ` : ''}
                </div>
            `;
            setTimeout(() => location.reload(), 3000);
        } else {
            throw new Error(result.detail || 'Upload failed');
        }
    } catch (error) {
        document.getElementById('upload-result').innerHTML = `
            <div class="bg-red-900/50 border border-red-700 rounded p-3">
                <p class="text-sm text-red-300">Error: ${error.message}</p>
            </div>
        `;
    } finally {
        document.getElementById('upload-result').classList.remove('hidden');
        document.getElementById('upload-btn').disabled = false;
        document.getElementById('upload-progress').classList.add('hidden');
    }
}

window.onclick = function(event) {
    const modal = document.getElementById('cv-upload-modal');
    if (event.target === modal) {
        window.closeUploadModal();
    }
}
</script>
{% endblock %}
