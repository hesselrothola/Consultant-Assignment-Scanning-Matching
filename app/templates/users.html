{% extends "base.html" %}

{% block title %}User Management{% endblock %}

{% block content %}
<!-- User Management Header -->
<div class="mb-8 flex justify-between items-center">
    <div>
        <h2 class="text-3xl font-bold bg-gradient-to-r from-violet-400 to-purple-400 bg-clip-text text-transparent">
            User Management
        </h2>
        <p class="mt-2 text-gray-400">Manage system users and access permissions</p>
    </div>
    <button onclick="showAddUserModal()" class="bg-gradient-to-r from-purple-600 to-purple-700 hover:from-purple-700 hover:to-purple-800 text-white font-medium px-6 py-3 rounded-lg transition-all duration-200 hover:scale-105 flex items-center space-x-2">
        <i class="fas fa-user-plus"></i>
        <span>Add New User</span>
    </button>
</div>

<!-- Users Table -->
<div class="glass-darker rounded-xl overflow-hidden">
    <div class="overflow-x-auto">
        <table class="w-full">
            <thead class="bg-gray-800/50 border-b border-gray-700">
                <tr>
                    <th class="px-6 py-4 text-left text-xs font-semibold text-gray-400 uppercase tracking-wider">Username</th>
                    <th class="px-6 py-4 text-left text-xs font-semibold text-gray-400 uppercase tracking-wider">Full Name</th>
                    <th class="px-6 py-4 text-left text-xs font-semibold text-gray-400 uppercase tracking-wider">Email</th>
                    <th class="px-6 py-4 text-left text-xs font-semibold text-gray-400 uppercase tracking-wider">Role</th>
                    <th class="px-6 py-4 text-left text-xs font-semibold text-gray-400 uppercase tracking-wider">Status</th>
                    <th class="px-6 py-4 text-left text-xs font-semibold text-gray-400 uppercase tracking-wider">Actions</th>
                </tr>
            </thead>
            <tbody class="divide-y divide-gray-700">
                {% for user in users %}
                <tr class="hover:bg-gray-800/30 transition-colors duration-200">
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="flex items-center">
                            <div class="w-8 h-8 bg-gradient-to-br from-purple-500 to-purple-600 rounded-full flex items-center justify-center mr-3">
                                <span class="text-white text-sm font-semibold">{{ user.username[0].upper() }}</span>
                            </div>
                            <span class="text-sm font-medium text-gray-200">{{ user.username }}</span>
                        </div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-300">{{ user.full_name }}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-300">{{ user.email }}</td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="px-3 py-1 inline-flex text-xs leading-5 font-semibold rounded-full 
                            {% if user.role == 'admin' %}bg-red-900/30 text-red-400 border border-red-800
                            {% elif user.role == 'manager' %}bg-blue-900/30 text-blue-400 border border-blue-800
                            {% else %}bg-gray-800 text-gray-400 border border-gray-700{% endif %}">
                            <i class="fas {% if user.role == 'admin' %}fa-crown{% elif user.role == 'manager' %}fa-user-tie{% else %}fa-user{% endif %} mr-1"></i>
                            {{ user.role|capitalize }}
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="px-3 py-1 inline-flex text-xs leading-5 font-semibold rounded-full 
                            {% if user.is_active %}bg-green-900/30 text-green-400 border border-green-800{% else %}bg-red-900/30 text-red-400 border border-red-800{% endif %}">
                            <i class="fas fa-circle text-xs mr-1"></i>
                            {% if user.is_active %}Active{% else %}Inactive{% endif %}
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                        <div class="flex space-x-2">
                            <button onclick="editUser('{{ user.user_id }}', '{{ user.username }}', '{{ user.full_name }}', '{{ user.email }}', '{{ user.role }}')" 
                                    class="text-purple-400 hover:text-purple-300 transition-colors duration-200" title="Edit">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button onclick="resetPassword('{{ user.user_id }}', '{{ user.username }}')" 
                                    class="text-yellow-400 hover:text-yellow-300 transition-colors duration-200" title="Reset Password">
                                <i class="fas fa-key"></i>
                            </button>
                            {% if user.username != 'admin' %}
                            <form method="POST" action="/consultant/users/{{ user.user_id }}/toggle-active" style="display: inline;">
                                <button type="submit" class="{% if user.is_active %}text-red-400 hover:text-red-300{% else %}text-green-400 hover:text-green-300{% endif %} transition-colors duration-200" 
                                        title="{% if user.is_active %}Deactivate{% else %}Activate{% endif %}">
                                    <i class="fas {% if user.is_active %}fa-user-slash{% else %}fa-user-check{% endif %}"></i>
                                </button>
                            </form>
                            {% endif %}
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- Add User Modal -->
<div id="addUserModal" class="hidden fixed inset-0 z-50 overflow-y-auto">
    <div class="flex items-center justify-center min-h-screen px-4">
        <!-- Backdrop -->
        <div class="fixed inset-0 bg-black/60 backdrop-blur-sm transition-opacity" onclick="hideAddUserModal()"></div>
        
        <!-- Modal -->
        <div class="relative glass-darker rounded-xl shadow-2xl max-w-md w-full p-6 glow-purple">
            <h3 class="text-2xl font-bold text-white mb-6">Add New User</h3>
            <form action="/consultant/users/add" method="POST" class="space-y-4">
                <div>
                    <label for="username" class="block text-sm font-medium text-gray-300 mb-1">Username</label>
                    <input type="text" name="username" id="username" required 
                           class="w-full px-4 py-2 bg-gray-800 border border-gray-700 rounded-lg text-gray-200 focus:outline-none focus:border-purple-500 transition-colors duration-200">
                </div>
                <div>
                    <label for="full_name" class="block text-sm font-medium text-gray-300 mb-1">Full Name</label>
                    <input type="text" name="full_name" id="full_name" required 
                           class="w-full px-4 py-2 bg-gray-800 border border-gray-700 rounded-lg text-gray-200 focus:outline-none focus:border-purple-500 transition-colors duration-200">
                </div>
                <div>
                    <label for="email" class="block text-sm font-medium text-gray-300 mb-1">Email</label>
                    <input type="email" name="email" id="email" required 
                           class="w-full px-4 py-2 bg-gray-800 border border-gray-700 rounded-lg text-gray-200 focus:outline-none focus:border-purple-500 transition-colors duration-200">
                </div>
                <div>
                    <label for="password" class="block text-sm font-medium text-gray-300 mb-1">Password</label>
                    <input type="password" name="password" id="password" required minlength="6"
                           class="w-full px-4 py-2 bg-gray-800 border border-gray-700 rounded-lg text-gray-200 focus:outline-none focus:border-purple-500 transition-colors duration-200">
                </div>
                <div>
                    <label for="role" class="block text-sm font-medium text-gray-300 mb-1">Role</label>
                    <select name="role" id="role" 
                            class="w-full px-4 py-2 bg-gray-800 border border-gray-700 rounded-lg text-gray-200 focus:outline-none focus:border-purple-500 transition-colors duration-200">
                        <option value="viewer">Viewer</option>
                        <option value="manager">Manager</option>
                        <option value="admin">Admin</option>
                    </select>
                </div>
                <div class="flex justify-end space-x-3 pt-4">
                    <button type="button" onclick="hideAddUserModal()" 
                            class="px-5 py-2 bg-gray-700 hover:bg-gray-600 text-gray-300 rounded-lg transition-colors duration-200">
                        Cancel
                    </button>
                    <button type="submit" 
                            class="px-5 py-2 bg-gradient-to-r from-purple-600 to-purple-700 hover:from-purple-700 hover:to-purple-800 text-white rounded-lg transition-all duration-200">
                        Add User
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Edit User Modal -->
<div id="editUserModal" class="hidden fixed inset-0 z-50 overflow-y-auto">
    <div class="flex items-center justify-center min-h-screen px-4">
        <!-- Backdrop -->
        <div class="fixed inset-0 bg-black/60 backdrop-blur-sm transition-opacity" onclick="hideEditUserModal()"></div>
        
        <!-- Modal -->
        <div class="relative glass-darker rounded-xl shadow-2xl max-w-md w-full p-6 glow-blue">
            <h3 class="text-2xl font-bold text-white mb-6">Edit User</h3>
            <form id="editUserForm" method="POST" class="space-y-4">
                <div>
                    <label for="edit_full_name" class="block text-sm font-medium text-gray-300 mb-1">Full Name</label>
                    <input type="text" name="full_name" id="edit_full_name" required 
                           class="w-full px-4 py-2 bg-gray-800 border border-gray-700 rounded-lg text-gray-200 focus:outline-none focus:border-blue-500 transition-colors duration-200">
                </div>
                <div>
                    <label for="edit_email" class="block text-sm font-medium text-gray-300 mb-1">Email</label>
                    <input type="email" name="email" id="edit_email" required 
                           class="w-full px-4 py-2 bg-gray-800 border border-gray-700 rounded-lg text-gray-200 focus:outline-none focus:border-blue-500 transition-colors duration-200">
                </div>
                <div>
                    <label for="edit_role" class="block text-sm font-medium text-gray-300 mb-1">Role</label>
                    <select name="role" id="edit_role" 
                            class="w-full px-4 py-2 bg-gray-800 border border-gray-700 rounded-lg text-gray-200 focus:outline-none focus:border-blue-500 transition-colors duration-200">
                        <option value="viewer">Viewer</option>
                        <option value="manager">Manager</option>
                        <option value="admin">Admin</option>
                    </select>
                </div>
                <div class="flex justify-end space-x-3 pt-4">
                    <button type="button" onclick="hideEditUserModal()" 
                            class="px-5 py-2 bg-gray-700 hover:bg-gray-600 text-gray-300 rounded-lg transition-colors duration-200">
                        Cancel
                    </button>
                    <button type="submit" 
                            class="px-5 py-2 bg-gradient-to-r from-blue-600 to-blue-700 hover:from-blue-700 hover:to-blue-800 text-white rounded-lg transition-all duration-200">
                        Update User
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Reset Password Modal -->
<div id="resetPasswordModal" class="hidden fixed inset-0 z-50 overflow-y-auto">
    <div class="flex items-center justify-center min-h-screen px-4">
        <!-- Backdrop -->
        <div class="fixed inset-0 bg-black/60 backdrop-blur-sm transition-opacity" onclick="hideResetPasswordModal()"></div>
        
        <!-- Modal -->
        <div class="relative glass-darker rounded-xl shadow-2xl max-w-md w-full p-6 glow-yellow">
            <h3 class="text-2xl font-bold text-white mb-2">Reset Password</h3>
            <p class="text-gray-400 mb-6">for user: <span id="reset_username" class="text-yellow-400 font-semibold"></span></p>
            <form id="resetPasswordForm" method="POST" class="space-y-4">
                <div>
                    <label for="new_password" class="block text-sm font-medium text-gray-300 mb-1">New Password</label>
                    <input type="password" name="new_password" id="new_password" required minlength="6"
                           class="w-full px-4 py-2 bg-gray-800 border border-gray-700 rounded-lg text-gray-200 focus:outline-none focus:border-yellow-500 transition-colors duration-200">
                </div>
                <div>
                    <label for="confirm_password" class="block text-sm font-medium text-gray-300 mb-1">Confirm Password</label>
                    <input type="password" id="confirm_password" required minlength="6"
                           class="w-full px-4 py-2 bg-gray-800 border border-gray-700 rounded-lg text-gray-200 focus:outline-none focus:border-yellow-500 transition-colors duration-200">
                </div>
                <div class="flex justify-end space-x-3 pt-4">
                    <button type="button" onclick="hideResetPasswordModal()" 
                            class="px-5 py-2 bg-gray-700 hover:bg-gray-600 text-gray-300 rounded-lg transition-colors duration-200">
                        Cancel
                    </button>
                    <button type="submit" 
                            class="px-5 py-2 bg-gradient-to-r from-yellow-600 to-yellow-700 hover:from-yellow-700 hover:to-yellow-800 text-white rounded-lg transition-all duration-200">
                        Reset Password
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
// Modal functions
function showAddUserModal() {
    document.getElementById('addUserModal').classList.remove('hidden');
    document.body.style.overflow = 'hidden';
}

function hideAddUserModal() {
    document.getElementById('addUserModal').classList.add('hidden');
    document.body.style.overflow = 'auto';
}

function editUser(userId, username, fullName, email, role) {
    document.getElementById('editUserModal').classList.remove('hidden');
    document.getElementById('edit_full_name').value = fullName;
    document.getElementById('edit_email').value = email;
    document.getElementById('edit_role').value = role;
    document.getElementById('editUserForm').action = '/consultant/users/' + userId + '/update';
    document.body.style.overflow = 'hidden';
}

function hideEditUserModal() {
    document.getElementById('editUserModal').classList.add('hidden');
    document.body.style.overflow = 'auto';
}

function resetPassword(userId, username) {
    document.getElementById('resetPasswordModal').classList.remove('hidden');
    document.getElementById('reset_username').textContent = username;
    document.getElementById('resetPasswordForm').action = '/consultant/users/' + userId + '/reset-password';
    document.body.style.overflow = 'hidden';
}

function hideResetPasswordModal() {
    document.getElementById('resetPasswordModal').classList.add('hidden');
    document.body.style.overflow = 'auto';
}

// Validate password match
document.getElementById('resetPasswordForm').addEventListener('submit', function(e) {
    var password = document.getElementById('new_password').value;
    var confirm = document.getElementById('confirm_password').value;
    if (password !== confirm) {
        e.preventDefault();
        alert('Passwords do not match!');
    }
});

// Add modal animation on show
document.addEventListener('DOMContentLoaded', function() {
    // Add fade-in animation to modals
    const modals = document.querySelectorAll('[id$="Modal"]');
    modals.forEach(modal => {
        const observer = new MutationObserver(function(mutations) {
            mutations.forEach(function(mutation) {
                if (mutation.target.classList.contains('hidden')) {
                    modal.style.opacity = '0';
                } else {
                    setTimeout(() => {
                        modal.style.transition = 'opacity 0.3s ease-in';
                        modal.style.opacity = '1';
                    }, 10);
                }
            });
        });
        observer.observe(modal, { attributes: true, attributeFilter: ['class'] });
    });
});
</script>
{% endblock %}